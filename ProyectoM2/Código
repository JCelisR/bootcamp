import json
import os
import csv

class GestorContactos:
    def __init__(self, archivo='contactos.json'):
        self.archivo = archivo
        self.contactos = self.cargar_contactos()

    def cargar_contactos(self):
        if not os.path.exists(self.archivo):
            return []
        try:
            with open(self.archivo, 'r', encoding='utf-8') as f:
                return json.load(f)
        except (json.JSONDecodeError, IOError):
            return []

    def guardar_contactos(self):
        try:
            with open(self.archivo, 'w', encoding='utf-8') as f:
                json.dump(self.contactos, f, indent=4, ensure_ascii=False)
        except IOError as e:
            print(f"Error al guardar: {e}")

    def agregar_contacto(self, nombre, telefono, correo, direccion):
        for c in self.contactos:
            if c['telefono'] == telefono:
                print(f"‚ùå Error: Ya existe un contacto con el tel√©fono {telefono}.")
                return

        nuevo_contacto = {
            'nombre': nombre,
            'telefono': telefono,
            'correo': correo,
            'direccion': direccion
        }
        self.contactos.append(nuevo_contacto)
        self.guardar_contactos()
        print(f"‚úÖ Contacto '{nombre}' agregado exitosamente.")

    def buscar_contactos(self, termino):
        termino = termino.lower()
        resultados = []
        for c in self.contactos:
            if termino in c['nombre'].lower() or termino in c['telefono']:
                resultados.append(c)
        return resultados

    def eliminar_contacto(self, telefono):
        inicial = len(self.contactos)
        self.contactos = [c for c in self.contactos if c['telefono'] != telefono]
        
        if len(self.contactos) < inicial:
            self.guardar_contactos()
            print("üóëÔ∏è Contacto eliminado correctamente.")
        else:
            print("‚ö†Ô∏è No se encontr√≥ ning√∫n contacto con ese tel√©fono.")

    def editar_contacto(self, telefono_busqueda):
        for c in self.contactos:
            if c['telefono'] == telefono_busqueda:
                print(f"\n‚úèÔ∏è Editando a: {c['nombre']}")
                print("(Deja el campo vac√≠o y presiona Enter para mantener el valor actual)")
                
                nuevo_nombre = input(f"Nombre [{c['nombre']}]: ") or c['nombre']
                nuevo_telefono = input(f"Tel√©fono [{c['telefono']}]: ") or c['telefono']
                nuevo_correo = input(f"Correo [{c['correo']}]: ") or c['correo']
                nueva_direccion = input(f"Direcci√≥n [{c['direccion']}]: ") or c['direccion']

                c['nombre'] = nuevo_nombre
                c['telefono'] = nuevo_telefono
                c['correo'] = nuevo_correo
                c['direccion'] = nueva_direccion
                
                self.guardar_contactos()
                print("‚úÖ Contacto actualizado exitosamente.")
                return
        print("‚ö†Ô∏è Contacto no encontrado.")

    def listar_contactos(self):
        if not self.contactos:
            print("üì≠ La agenda est√° vac√≠a.")
            return
        
        print("\n" + "="*85)
        print(f"{'NOMBRE':<20} | {'TEL√âFONO':<15} | {'CORREO':<25} | {'DIRECCI√ìN'}")
        print("="*85)
        for c in self.contactos:
            print(f"{c['nombre']:<20} | {c['telefono']:<15} | {c['correo']:<25} | {c['direccion']}")
        print("="*85 + "\n")

    def exportar_csv(self, nombre_archivo='contactos_exportados.csv'):
        """Exporta la lista de contactos a un archivo CSV compatible con Excel."""
        if not self.contactos:
            print("‚ö†Ô∏è No hay contactos para exportar.")
            return

        try:
            with open(nombre_archivo, 'w', newline='', encoding='utf-8-sig') as f:
                writer = csv.writer(f, delimiter=';') 
                
                writer.writerow(['Nombre', 'Tel√©fono', 'Correo', 'Direcci√≥n'])
                
                for c in self.contactos:
                    writer.writerow([c['nombre'], c['telefono'], c['correo'], c['direccion']])
            
            print(f"‚úÖ Archivo generado exitosamente: {nombre_archivo}")
            print("   (Puedes abrirlo directamente con Excel)")
        except IOError as e:
            print(f"‚ùå Error al exportar: {e}")


def main():
    gestor = GestorContactos()
    
    while True:
        print("\n--- üìí SISTEMA DE GESTI√ìN DE CONTACTOS V2 ---")
        print("1. Agregar Contacto")
        print("2. Buscar Contacto")
        print("3. Editar Contacto")
        print("4. Eliminar Contacto")
        print("5. Ver Todos")
        print("6. Exportar a Excel (CSV)")
        print("7. Salir")
        
        opcion = input("\nSeleccione una opci√≥n: ")

        if opcion == '1':
            nombre = input("Nombre: ")
            telefono = input("Tel√©fono: ")
            correo = input("Correo: ")
            direccion = input("Direcci√≥n: ")
            gestor.agregar_contacto(nombre, telefono, correo, direccion)
            
        elif opcion == '2':
            termino = input("Ingrese nombre o tel√©fono a buscar: ")
            resultados = gestor.buscar_contactos(termino)
            if resultados:
                print(f"\nüîç Se encontraron {len(resultados)} coincidencias:")
                for c in resultados:
                    print(f"- {c['nombre']} ({c['telefono']}) | {c['correo']}")
            else:
                print("‚ö†Ô∏è No se encontraron coincidencias.")

        elif opcion == '3':
            tel = input("Ingrese el tel√©fono del contacto a editar: ")
            gestor.editar_contacto(tel)

        elif opcion == '4':
            tel = input("Ingrese el tel√©fono del contacto a eliminar: ")
            confirmacion = input("¬øEst√° seguro? (s/n): ")
            if confirmacion.lower() == 's':
                gestor.eliminar_contacto(tel)

        elif opcion == '5':
            gestor.listar_contactos()

        elif opcion == '6':
            gestor.exportar_csv()

        elif opcion == '7':
            print("üëã ¬°Hasta luego!")
            break
        
        else:
            print("Opci√≥n no v√°lida.")

if __name__ == "__main__":
    main()
    