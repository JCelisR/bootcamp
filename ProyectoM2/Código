import json
import os
import csv

class GestorContactos:
    def __init__(self, archivo='contactos.json'):
        self.archivo = archivo
        self.contactos = self.cargar_contactos()

    def cargar_contactos(self):
        if not os.path.exists(self.archivo):
            return []
        try:
            with open(self.archivo, 'r', encoding='utf-8') as f:
                return json.load(f)
        except (json.JSONDecodeError, IOError):
            return []

    def guardar_contactos(self):
        try:
            with open(self.archivo, 'w', encoding='utf-8') as f:
                json.dump(self.contactos, f, indent=4, ensure_ascii=False)
        except IOError as e:
            print(f"Error al guardar: {e}")

    def agregar_contacto(self, nombre, telefono, correo, direccion):
        for c in self.contactos:
            if c.get('telefono') and c['telefono'] == telefono and telefono != '':
                print(f"‚ùå Error: Ya existe un contacto con el tel√©fono {telefono}.")
                return

        nuevo_contacto = {
            'nombre': nombre,
            'telefono': telefono,
            'correo': correo,
            'direccion': direccion
        }
        self.contactos.append(nuevo_contacto)
        self.guardar_contactos()
        print(f"‚úÖ Contacto '{nombre}' agregado exitosamente.")

    def buscar_contactos(self, termino):
        termino = termino.lower()
        resultados = []
        for c in self.contactos:
            if termino in c.get('nombre', '').lower() or termino in c.get('telefono', ''):
                resultados.append(c)
        return resultados

    def eliminar_contacto(self, telefono):
        inicial = len(self.contactos)
        self.contactos = [c for c in self.contactos if c.get('telefono') != telefono]

        if len(self.contactos) < inicial:
            self.guardar_contactos()
            print("üóëÔ∏è Contacto eliminado correctamente.")
        else:
            print("‚ö†Ô∏è No se encontr√≥ ning√∫n contacto con ese tel√©fono.")

    def editar_contacto(self, telefono_busqueda):
        for c in self.contactos:
            if c.get('telefono') == telefono_busqueda:
                print(f"\n‚úèÔ∏è Editando a: {c.get('nombre','')}")
                print("(Deja el campo vac√≠o y presiona Enter para mantener el valor actual)")

                nuevo_nombre = input(f"Nombre [{c.get('nombre','')}]: ") or c.get('nombre','')
                nuevo_telefono = input(f"Tel√©fono [{c.get('telefono','')}]: ") or c.get('telefono','')
                nuevo_correo = input(f"Correo [{c.get('correo','')}]: ") or c.get('correo','')
                nueva_direccion = input(f"Direcci√≥n [{c.get('direccion','')}]: ") or c.get('direccion','')

                if nuevo_telefono != c.get('telefono',''):
                    for otro in self.contactos:
                        if otro is not c and otro.get('telefono') == nuevo_telefono and nuevo_telefono != '':
                            print(f"‚ùå Error: Otro contacto ya usa el tel√©fono {nuevo_telefono}. Edici√≥n cancelada.")
                            return

                c['nombre'] = nuevo_nombre
                c['telefono'] = nuevo_telefono
                c['correo'] = nuevo_correo
                c['direccion'] = nueva_direccion

                self.guardar_contactos()
                print("‚úÖ Contacto actualizado exitosamente.")
                return
        print("‚ö†Ô∏è Contacto no encontrado.")

    def listar_contactos(self):
        if not self.contactos:
            print("üì≠ La agenda est√° vac√≠a.")
            return

        print("\n" + "="*85)
        print(f"{'NOMBRE':<20} | {'TEL√âFONO':<15} | {'CORREO':<25} | {'DIRECCI√ìN'}")
        print("="*85)
        for c in self.contactos:
            print(f"{c.get('nombre',''):<20} | {c.get('telefono',''):<15} | {c.get('correo',''):<25} | {c.get('direccion','')}")
        print("="*85 + "\n")

    def exportar_csv(self, nombre_archivo='contactos_exportados.csv'):
        """Exporta la lista de contactos a un archivo CSV compatible con Excel."""
        if not self.contactos:
            print("‚ö†Ô∏è No hay contactos para exportar.")
            return

        try:
            with open(nombre_archivo, 'w', newline='', encoding='utf-8-sig') as f:
                writer = csv.writer(f, delimiter=';')
                writer.writerow(['Nombre', 'Tel√©fono', 'Correo', 'Direcci√≥n'])
                for c in self.contactos:
                    writer.writerow([c.get('nombre',''), c.get('telefono',''), c.get('correo',''), c.get('direccion','')])
            print(f"‚úÖ Archivo generado exitosamente: {nombre_archivo}")
            print("   (Puedes abrirlo directamente con Excel)")
        except IOError as e:
            print(f"‚ùå Error al exportar: {e}")

    def importar_csv(self, nombre_archivo='contactos.csv', delimiter=';'):
        """
        Importa contactos desde un archivo CSV y los agrega a self.contactos evitando duplicados.
        - Busca columnas por nombre (insensible a may√∫sculas): Nombre, Tel√©fono, Correo, Direcci√≥n.
        - Evita duplicados bas√°ndose en 'telefono' cuando est√© presente; si no hay tel√©fono,
          usa la combinaci√≥n nombre+correo como respaldo.
        - Guarda los cambios en el JSON existente al finalizar.
        """
        if not os.path.exists(nombre_archivo):
            print(f"‚ö†Ô∏è No se encontr√≥ el archivo: {nombre_archivo}")
            return

        a√±adidos = 0
        saltados = 0

        try:
            with open(nombre_archivo, 'r', encoding='utf-8-sig', newline='') as f:
                reader = csv.reader(f, delimiter=delimiter)
                try:
                    encabezado = next(reader)
                except StopIteration:
                    print("‚ö†Ô∏è El archivo CSV est√° vac√≠o.")
                    return

                cols = [c.strip().lower() for c in encabezado]

                def idx_of(names):
                    for name in names:
                        if name in cols:
                            return cols.index(name)
                    return None

                idx_nombre = idx_of(['nombre', 'name'])
                idx_telefono = idx_of(['telefono', 'tel√©fono', 'phone'])
                idx_correo = idx_of(['correo', 'email', 'e-mail', 'mail'])
                idx_direccion = idx_of(['direccion', 'direcci√≥n', 'address'])

                for fila in reader:
                    if not any(cell.strip() for cell in fila):
                        continue

                    nombre = fila[idx_nombre].strip() if idx_nombre is not None and idx_nombre < len(fila) else ''
                    telefono = fila[idx_telefono].strip() if idx_telefono is not None and idx_telefono < len(fila) else ''
                    correo = fila[idx_correo].strip() if idx_correo is not None and idx_correo < len(fila) else ''
                    direccion = fila[idx_direccion].strip() if idx_direccion is not None and idx_direccion < len(fila) else ''

                    telefono_norm = telefono.replace(' ', '')

                    es_duplicado = False
                    if telefono_norm:
                        for c in self.contactos:
                            if c.get('telefono') and c.get('telefono').replace(' ', '') == telefono_norm:
                                es_duplicado = True
                                break
                    else:
                        clave = (nombre.lower(), correo.lower())
                        for c in self.contactos:
                            if (c.get('nombre','').lower(), c.get('correo','').lower()) == clave and (nombre or correo):
                                es_duplicado = True
                                break

                    if es_duplicado:
                        saltados += 1
                        continue

                    nuevo = {
                        'nombre': nombre,
                        'telefono': telefono_norm,
                        'correo': correo,
                        'direccion': direccion
                    }
                    self.contactos.append(nuevo)
                    a√±adidos += 1

            if a√±adidos > 0:
                self.guardar_contactos()

            print(f"‚úÖ Importaci√≥n finalizada. A√±adidos: {a√±adidos}. Saltados por duplicado: {saltados}.")
        except Exception as e:
            print(f"‚ùå Error al importar CSV: {e}")


def main():
    gestor = GestorContactos()

    while True:
        print("\n--- üìí SISTEMA DE GESTI√ìN DE CONTACTOS V2 ---")
        print("1. Agregar Contacto")
        print("2. Buscar Contacto")
        print("3. Editar Contacto")
        print("4. Eliminar Contacto")
        print("5. Ver Todos")
        print("6. Exportar a Excel (CSV)")
        print("7. Importar desde CSV")
        print("8. Salir")

        opcion = input("\nSeleccione una opci√≥n: ")

        if opcion == '1':
            nombre = input("Nombre: ")
            telefono = input("Tel√©fono: ")
            correo = input("Correo: ")
            direccion = input("Direcci√≥n: ")
            gestor.agregar_contacto(nombre, telefono, correo, direccion)

        elif opcion == '2':
            termino = input("Ingrese nombre o tel√©fono a buscar: ")
            resultados = gestor.buscar_contactos(termino)
            if resultados:
                print(f"\nüîç Se encontraron {len(resultados)} coincidencias:")
                for c in resultados:
                    print(f"- {c.get('nombre','')} ({c.get('telefono','')}) | {c.get('correo','')}")
            else:
                print("‚ö†Ô∏è No se encontraron coincidencias.")

        elif opcion == '3':
            tel = input("Ingrese el tel√©fono del contacto a editar: ")
            gestor.editar_contacto(tel)

        elif opcion == '4':
            tel = input("Ingrese el tel√©fono del contacto a eliminar: ")
            confirmacion = input("¬øEst√° seguro? (s/n): ")
            if confirmacion.lower() == 's':
                gestor.eliminar_contacto(tel)

        elif opcion == '5':
            gestor.listar_contactos()

        elif opcion == '6':
            gestor.exportar_csv()

        elif opcion == '7':
            ruta = input("Ruta del archivo CSV (por defecto 'contactos.csv'): ").strip() or 'contactos.csv'
            sep = input("Separador del CSV (por defecto ';'): ").strip() or ';'
            gestor.importar_csv(ruta, delimiter=sep)

        elif opcion == '8':
            print("üëã ¬°Hasta luego!")
            break

        else:
            print("Opci√≥n no v√°lida.")

if __name__ == "__main__":
    main()
    