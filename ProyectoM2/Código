import json
import os

class GestorContactos:
    def __init__(self, archivo='contactos.json'):
        self.archivo = archivo
        self.contactos = self.cargar_contactos()

    def cargar_contactos(self):
        """Carga los contactos desde el archivo JSON si existe."""
        if not os.path.exists(self.archivo):
            return []
        try:
            with open(self.archivo, 'r', encoding='utf-8') as f:
                return json.load(f)
        except (json.JSONDecodeError, IOError):
            return []

    def guardar_contactos(self):
        """Guarda la lista actual de contactos en el archivo JSON."""
        try:
            with open(self.archivo, 'w', encoding='utf-8') as f:
                json.dump(self.contactos, f, indent=4, ensure_ascii=False)
        except IOError as e:
            print(f"Error al guardar: {e}")

    def agregar_contacto(self, nombre, telefono, correo, direccion):
        """Agrega un nuevo contacto si el tel√©fono no existe."""
        # Verificar duplicados por tel√©fono
        for c in self.contactos:
            if c['telefono'] == telefono:
                print(f"‚ùå Error: Ya existe un contacto con el tel√©fono {telefono}.")
                return

        nuevo_contacto = {
            'nombre': nombre,
            'telefono': telefono,
            'correo': correo,
            'direccion': direccion
        }
        self.contactos.append(nuevo_contacto)
        self.guardar_contactos()
        print(f"‚úÖ Contacto '{nombre}' agregado exitosamente.")

    def buscar_contactos(self, termino):
        """Busca por nombre o tel√©fono y devuelve una lista de coincidencias."""
        termino = termino.lower()
        resultados = []
        for c in self.contactos:
            if termino in c['nombre'].lower() or termino in c['telefono']:
                resultados.append(c)
        return resultados

    def eliminar_contacto(self, telefono):
        """Elimina un contacto basado en su n√∫mero de tel√©fono."""
        inicial = len(self.contactos)
        self.contactos = [c for c in self.contactos if c['telefono'] != telefono]
        
        if len(self.contactos) < inicial:
            self.guardar_contactos()
            print("üóëÔ∏è Contacto eliminado correctamente.")
            return True
        else:
            print("‚ö†Ô∏è No se encontr√≥ ning√∫n contacto con ese tel√©fono.")
            return False

    def editar_contacto(self, telefono_busqueda):
        """Busca un contacto y permite editar sus campos."""
        for c in self.contactos:
            if c['telefono'] == telefono_busqueda:
                print(f"\n‚úèÔ∏è Editando a: {c['nombre']}")
                print("(Deja el campo vac√≠o y presiona Enter para mantener el valor actual)")
                
                nuevo_nombre = input(f"Nombre [{c['nombre']}]: ") or c['nombre']
                nuevo_telefono = input(f"Tel√©fono [{c['telefono']}]: ") or c['telefono']
                nuevo_correo = input(f"Correo [{c['correo']}]: ") or c['correo']
                nueva_direccion = input(f"Direcci√≥n [{c['direccion']}]: ") or c['direccion']

                # Actualizar datos
                c['nombre'] = nuevo_nombre
                c['telefono'] = nuevo_telefono
                c['correo'] = nuevo_correo
                c['direccion'] = nueva_direccion
                
                self.guardar_contactos()
                print("‚úÖ Contacto actualizado exitosamente.")
                return
        print("‚ö†Ô∏è Contacto no encontrado.")

    def listar_contactos(self):
        """Muestra todos los contactos en formato tabla."""
        if not self.contactos:
            print("üì≠ La agenda est√° vac√≠a.")
            return
        
        print("\n" + "="*85)
        print(f"{'NOMBRE':<20} | {'TEL√âFONO':<15} | {'CORREO':<25} | {'DIRECCI√ìN'}")
        print("="*85)
        for c in self.contactos:
            print(f"{c['nombre']:<20} | {c['telefono']:<15} | {c['correo']:<25} | {c['direccion']}")
        print("="*85 + "\n")

# --- Interfaz de Consola (Men√∫ Principal) ---

def limpiar_pantalla():
    os.system('cls' if os.name == 'nt' else 'clear')

def main():
    gestor = GestorContactos()
    
    while True:
        print("\n--- üìí SISTEMA DE GESTI√ìN DE CONTACTOS ---")
        print("1. Agregar Contacto")
        print("2. Buscar Contacto")
        print("3. Editar Contacto")
        print("4. Eliminar Contacto")
        print("5. Ver Todos")
        print("6. Salir")
        
        opcion = input("\nSeleccione una opci√≥n: ")

        if opcion == '1':
            nombre = input("Nombre: ")
            telefono = input("Tel√©fono: ")
            correo = input("Correo: ")
            direccion = input("Direcci√≥n: ")
            gestor.agregar_contacto(nombre, telefono, correo, direccion)
            
        elif opcion == '2':
            termino = input("Ingrese nombre o tel√©fono a buscar: ")
            resultados = gestor.buscar_contactos(termino)
            if results := resultados:
                print(f"\nüîç Se encontraron {len(resultados)} coincidencias:")
                for c in resultados:
                    print(f"- {c['nombre']} ({c['telefono']}) | {c['correo']}")
            else:
                print("‚ö†Ô∏è No se encontraron coincidencias.")

        elif opcion == '3':
            tel = input("Ingrese el tel√©fono del contacto a editar: ")
            gestor.editar_contacto(tel)

        elif opcion == '4':
            tel = input("Ingrese el tel√©fono del contacto a eliminar: ")
            confirmacion = input("¬øEst√° seguro? (s/n): ")
            if confirmacion.lower() == 's':
                gestor.eliminar_contacto(tel)

        elif opcion == '5':
            gestor.listar_contactos()

        elif opcion == '6':
            print("üëã ¬°Hasta luego!")
            break
        
        else:
            print("Opci√≥n no v√°lida.")

if __name__ == "__main__":
    main()